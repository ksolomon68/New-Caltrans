<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Search and filter contracting opportunities tailored to your business capabilities and regions.">
    <title>Search Opportunities - CaltransBizConnect</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/dashboard-new.css">
    <link rel="stylesheet" href="css/dashboard-common.css">
    <style>
        /* Modern, clean search interface */
        body.dashboard-v2 {
            background: linear-gradient(135deg, var(--color-bg-secondary) 0%, var(--color-bg-tertiary) 100%);
        }

        .search-hero {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--space-2xl);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border-light);
        }

        .search-header {
            text-align: center;
            margin-bottom: var(--space-lg);
        }

        .search-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-primary);
            margin: 0 0 var(--space-sm) 0;
        }

        .search-header p {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin: 0;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .search-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--space-xl);
            margin-bottom: var(--space-xl);
        }

        .filters-panel {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border-light);
        }

        .filters-panel h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-lg) 0;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .filter-group {
            margin-bottom: var(--space-md);
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-group label {
            display: block;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
            font-size: 0.875rem;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: var(--space-sm);
            border: 1px solid var(--color-border-light);
            border-radius: var(--border-radius-md);
            font-size: 0.9rem;
            transition: border-color var(--transition-base);
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 90, 140, 0.1);
        }

        .search-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
        }

        .results-section {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border-light);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .results-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .opportunity-grid {
            display: grid;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .no-results {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--space-2xl);
            text-align: center;
            border: 1px solid var(--color-border-light);
        }

        .no-results h3 {
            color: var(--color-primary);
            margin: 0 0 var(--space-md) 0;
        }

        .no-results p {
            color: var(--text-muted);
            margin: var(--space-md) 0;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--color-bg-primary) 0%, #f8fafc 100%);
            border: 1px solid var(--color-border-light);
            border-radius: var(--border-radius-md);
            padding: var(--space-lg);
            text-align: center;
            transition: transform var(--transition-base);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--color-primary);
            margin-bottom: var(--space-xs);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @media (max-width: 1024px) {
            .search-layout {
                grid-template-columns: 1fr;
            }

            .opportunity-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body class="dashboard-v2">
    <aside class="sidebar" id="sidebar"></aside>

    <div class="dashboard-container">
        <header class="header-top" id="header-top"></header>

        <!-- Main Content -->
        <main id="main-content" class="main-content">

            <!-- Modern Search Hero Section -->
            <section class="search-hero">
                <div class="search-header">
                    <h1>üîç Opportunity Search</h1>
                    <p>Find your next contracting opportunity with our powerful search tools</p>
                </div>

                <!-- Quick Stats -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-number" id="totalOpportunities">--</div>
                        <div class="stat-label">Total Opportunities</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="newThisWeek">--</div>
                        <div class="stat-label">New This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="matchingProfile">--</div>
                        <div class="stat-label">Matching Your Profile</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="savedCount">--</div>
                        <div class="stat-label">Saved Opportunities</div>
                    </div>
                </div>
            </section>

            <div class="search-layout">
                <!-- Filters Panel -->
                <div class="filters-panel">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon
                                points="22 12 18 12 2 9a3 3 0 0 1 3h6a3 3 0 0 1-3 3V8a3 3 0 0 1-3 3s-.83-.21-.12-.28-.12-.28.1.21-.21.28-.12-.28.1.21-.21.28-.12-.28.01.56.01.56 1.08.01.56v4.17l-1.86-1.86a3 3 0 0 0-1.21.3.16-1.56.01.56-1.08.01.56V21A3 3 0 0 0 1.21 3.16 1.56z">
                            </polygon>
                        </svg>
                        Filter Opportunities
                    </h3>

                    <div class="filter-group">
                        <label for="districtFilter">üìç District/Region</label>
                        <select id="districtFilter" name="district">
                            <option value="">All Districts</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="categoryFilter">üèóÔ∏è Work Category</label>
                        <select id="categoryFilter" name="category">
                            <option value="">All Categories</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="dueDateFilter">üìÖ Due Date</label>
                        <select id="dueDateFilter" name="dueDate">
                            <option value="">Any Time</option>
                            <option value="7">Next 7 Days</option>
                            <option value="14">Next 14 Days</option>
                            <option value="30">Next 30 Days</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="keywordFilter">üîç Keywords</label>
                        <input type="text" id="keywordFilter" name="keywords"
                            placeholder="Search by title, description, or ID...">
                    </div>

                    <div class="search-actions">
                        <button type="button" id="clearFilters" class="btn btn-outline">Clear All</button>
                        <button type="button" id="applyFilters" class="btn btn-primary">Search</button>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="results-section">
                    <div class="results-header">
                        <h3>Search Results</h3>
                        <p id="resultsCount" class="text-muted"><strong>Loading...</strong></p>
                    </div>

                    <div id="opportunityList" class="opportunity-grid">
                        <!-- Opportunities will be loaded here by JavaScript -->
                    </div>

                    <div id="noResults" class="no-results" style="display: none;">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1" style="opacity: 0.3; margin-bottom: var(--space-md);">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="M21 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <line x1="9" y1="9" x2="21" y2="9"></line>
                        </svg>
                        <h3>No Opportunities Found</h3>
                        <p>Try adjusting your search filters to find more matching opportunities.</p>
                        <div class="search-actions">
                            <button type="button" id="clearNoResults" class="btn btn-outline">Clear Filters</button>
                            <button type="button" id="refreshSearch" class="btn btn-primary">Refresh Search</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Opportunity Details View (initially hidden) -->
            <div id="opportunityDetail" class="results-section" style="display: none;">
                <div
                    style="margin-bottom: var(--space-lg); display: flex; justify-content: space-between; align-items: flex-start;">
                    <button id="backBtn" class="btn btn-outline btn-small">‚Üê Back to Results</button>
                    <div id="detailActions"></div>
                </div>
                <div id="detailContent">
                    <!-- Loaded dynamically -->
                </div>
            </div>
        </main>


    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils/data-resilience.js"></script>
    <script src="js/components/navigation.js"></script>
    <script>
        // Initialize vendor dashboard with opportunity search
        document.addEventListener('DOMContentLoaded', async () => {
            setTimeout(() => {
                Navigation.init('vendor');
            }, 50);

            const API_BASE = window.APP_CONFIG ? window.APP_CONFIG.API_URL : '/api';

            let allOpps = [];

            // Add clear filters functionality
            const clearFiltersBtn = document.getElementById('clearFilters');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    document.getElementById('districtFilter').value = '';
                    document.getElementById('categoryFilter').value = '';
                    document.getElementById('dueDateFilter').value = '';
                    document.getElementById('keywordFilter').value = '';
                    applyFilters();
                });
            }

            // Populate filters from JSON
            async function populateFilters() {
                try {
                    const [districtsData, categoriesData] = await Promise.all([
                        fetch('data/districts.json').then(r => r.json()),
                        fetch('data/work-categories.json').then(r => r.json())
                    ]);

                    const distSelect = document.getElementById('districtFilter');
                    districtsData.districts.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.id;
                        opt.textContent = d.name;
                        distSelect.appendChild(opt);
                    });

                    const catSelect = document.getElementById('categoryFilter');
                    categoriesData.categories.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name;
                        catSelect.appendChild(opt);
                    });
                } catch (e) {
                    console.error('Error populating filters:', e);
                }
            }

            window.applyFilters = function () {
                window.displayOpportunities(allOpps);
            };

            window.displayOpportunities = function (opportunities) {
                const listOpps = opportunities || allOpps;
                const districtFilter = document.getElementById('districtFilter').value;
                const categoryFilter = document.getElementById('categoryFilter').value;
                const dueDateFilter = document.getElementById('dueDateFilter').value;
                const keywordFilter = document.getElementById('keywordFilter').value.toLowerCase();

                console.log('Filtering opportunities:', listOpps.length);
                const filteredOpps = listOpps.filter(opp => {
                    const status = (opp.status || 'published').toLowerCase();
                    if (status !== 'published' && status !== 'open') {
                        // console.log('Skipping due to status:', opp.id, status);
                        return false;
                    }

                    if (districtFilter && opp.district != districtFilter) return false; // loose equality for string/number match
                    if (categoryFilter && opp.category != categoryFilter) return false;

                    if (dueDateFilter) {
                        const dueDateVal = opp.dueDate || opp.due_date;
                        if (!dueDateVal) return false;
                        const dueDate = new Date(dueDateVal);
                        const daysUntilDue = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                        if (daysUntilDue > parseInt(dueDateFilter)) return false;
                    }

                    if (keywordFilter) {
                        const searchableText = `${opp.title} ${opp.scope_summary || opp.scopeSummary} ${opp.district_name || opp.districtName} ${opp.category_name || opp.categoryName} ${opp.id}`.toLowerCase();
                        if (!searchableText.includes(keywordFilter)) return false;
                    }
                    return true;
                });
                console.log('Filtered down to:', filteredOpps.length);

                renderOpportunities(filteredOpps);
            };

            window.renderOpportunities = function (opportunities) {
                const listEl = document.getElementById('opportunityList');
                const noResultsEl = document.getElementById('noResults');
                const resultsCountEl = document.getElementById('resultsCount');

                if (opportunities.length === 0) {
                    listEl.style.display = 'none';
                    noResultsEl.style.display = 'block';
                    resultsCountEl.innerHTML = 'No <strong>opportunities</strong> found';
                    return;
                }

                listEl.style.display = 'grid';
                noResultsEl.style.display = 'none';
                resultsCountEl.innerHTML = `Showing <strong>${opportunities.length}</strong> ${opportunities.length === 1 ? 'opportunity' : 'opportunities'}`;
                listEl.innerHTML = '';

                opportunities.forEach(opp => {
                    const card = document.createElement('div');
                    card.className = 'content-card';
                    card.style.cssText = `
                        background: var(--card-bg);
                        border: 1px solid var(--color-border-light);
                        border-radius: var(--border-radius-md);
                        padding: var(--space-lg);
                        transition: transform var(--transition-base);
                        cursor: pointer;
                    `;

                    const dueDateVal = opp.dueDate || opp.due_date;
                    const dueDate = new Date(dueDateVal);
                    const daysUntilDue = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                    const urgencyClass = (daysUntilDue <= 7 && daysUntilDue >= 0) ? 'badge-warning' : (daysUntilDue < 0 ? 'badge-error' : 'badge-success');
                    const urgencyLabel = (daysUntilDue <= 7 && daysUntilDue >= 0) ? 'Due Soon' : (daysUntilDue < 0 ? 'Closed' : daysUntilDue + ' days');
                    const distName = opp.district_name || opp.districtName || 'District ' + opp.district;
                    const catName = opp.category_name || opp.categoryName || 'General';

                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-md);">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 var(--space-xs) 0; color: var(--color-primary); font-size: 1.25rem; font-weight: 600;">
                                    ${opp.title}
                                </h3>
                                <div style="display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-top: var(--space-sm);">
                                    <span class="badge badge-secondary">${catName}</span>
                                    <span class="badge badge-secondary">${distName}</span>
                                    <span class="badge ${urgencyClass}">${urgencyLabel}</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="margin-bottom: var(--space-xs);">
                                    <strong style="color: var(--color-primary); font-size: 1.5rem;">${opp.estimated_value || opp.estimatedValue || 'TBD'}</strong>
                                    <div style="font-size: 0.875rem; color: var(--text-muted);">Estimated Value</div>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">
                                    ID: ${opp.id}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-sm); justify-content: flex-end;">
                            <button class="btn btn-outline btn-small save-btn" onclick="event.stopPropagation(); window.toggleSave('${opp.id}', this)">
                                ${window.savedOpportunityIds.has(opp.id) ? 'Unsave' : 'Save'}
                            </button>
                            <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); window.loadDetail('${opp.id}')">View Details</button>
                        </div>
                    `;

                    card.onclick = () => window.loadDetail(opp.id);

                    card.addEventListener('mouseenter', () => {
                        card.style.transform = 'translateY(-4px)';
                        card.style.boxShadow = 'var(--shadow-lg)';
                    });

                    card.addEventListener('mouseleave', () => {
                        card.style.transform = 'translateY(0)';
                        card.style.boxShadow = 'var(--shadow-sm)';
                    });

                    listEl.appendChild(card);
                });
            };

            try {
                await populateFilters();
                const data = await DataService.fetch(`/opportunities`);
                if (!data || !Array.isArray(data)) throw new Error('Invalid data');
                allOpps = data;

                const user = Auth.getUser();
                window.savedOpportunityIds = new Set();
                if (user && user.type === 'vendor') {
                    const saved = await DataService.fetch(`/opportunities/saved/${user.id}`).catch(() => []);
                    window.savedOpportunityIds = new Set(saved ? saved.map(o => o.id) : []);
                    const savedCountEl = document.getElementById('savedCount');
                    if (savedCountEl) savedCountEl.textContent = window.savedOpportunityIds.size;
                }

                const totalOppsEl = document.getElementById('totalOpportunities');
                if (totalOppsEl) totalOppsEl.textContent = allOpps.length;

                const newThisWeekEl = document.getElementById('newThisWeek');
                if (newThisWeekEl) {
                    newThisWeekEl.textContent = allOpps.filter(o => {
                        const posted = new Date(o.posted_date || o.postedDate);
                        return posted > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    }).length;
                }

                window.displayOpportunities(allOpps);

                window.toggleSave = async function (id, btn) {
                    const user = Auth.getUser();
                    if (!user) {
                        alert('Please log in to save opportunities');
                        window.location.href = 'login.html';
                        return;
                    }

                    const isSaved = window.savedOpportunityIds.has(id);
                    try {
                        const res = await fetch(`${API_BASE}/opportunities/${isSaved ? 'unsave' : 'save'}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ vendorId: user.id, opportunityId: id })
                        });

                        if (res.ok) {
                            if (isSaved) {
                                window.savedOpportunityIds.delete(id);
                                btn.textContent = 'Save';
                            } else {
                                window.savedOpportunityIds.add(id);
                                btn.textContent = 'Unsave';
                            }

                            const savedCountEl = document.getElementById('savedCount');
                            if (savedCountEl) {
                                savedCountEl.textContent = window.savedOpportunityIds.size;
                            }
                        }
                    } catch (e) {
                        console.error('Toggle save error:', e);
                        alert('Error updating saved status. Please try again.');
                    }
                };

                window.loadDetail = function (id) {
                    const user = Auth.getUser();
                    if (!user) {
                        alert('Please log in to view opportunity details');
                        window.location.href = 'login.html';
                        return;
                    }
                    window.location.href = `opportunity-details.html?id=${id}`;
                };

                // Apply filters on input changes
                ['districtFilter', 'categoryFilter', 'dueDateFilter'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', window.applyFilters);
                });

                const keywordEl = document.getElementById('keywordFilter');
                if (keywordEl) keywordEl.addEventListener('input', window.applyFilters);

                const applyBtn = document.getElementById('applyFilters');
                if (applyBtn) applyBtn.onclick = window.applyFilters;

            } catch (error) {
                console.error('Search init error:', error);
                const listEl = document.getElementById('opportunityList');
                if (listEl) listEl.innerHTML = '<div style="color:var(--color-error)">Error loading data. Please check your connection.</div>';
            }
        });
    </script>

</body>

</html>
