<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="View your saved contracting opportunities.">
    <title>Saved Opportunities - CaltransBizConnect</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/dashboard-new.css">
    <link rel="stylesheet" href="css/dashboard-common.css">
</head>

<body class="dashboard-v2">
    <aside class="sidebar" id="sidebar"></aside>

    <div class="dashboard-container">
        <header class="header-top" id="header-top"></header>

        <!-- Main Content -->
        <main id="main-content" class="main-content">

            <!-- Hero Section -->
            <section class="hero-section">
                <div class="hero-content">
                    <div class="hero-welcome">
                        <h1 class="page-title">Saved Opportunities</h1>
                        <p>View and manage your saved contracting opportunities</p>
                    </div>
                </div>
            </section>

            <!-- Saved Opportunities List -->
            <div class="content-card">
                <h3>Your Saved Opportunities</h3>
                <div id="savedOpportunitiesList" style="margin-top: var(--space-lg);">
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        Loading saved opportunities...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils/data-resilience.js"></script>
    <script src="js/components/navigation.js"></script>
    <script>
        // Initialize vendor dashboard with saved opportunities
        document.addEventListener('DOMContentLoaded', async function () {
            setTimeout(() => {
                Navigation.init('vendor');
                loadSavedOpportunities();
            }, 50);
        });

        async function loadSavedOpportunities() {
            const user = JSON.parse(localStorage.getItem('caltrans_user'));
            if (!user) return;

            try {
                // Use DataService for resilient fetching
                const savedOpps = await DataService.fetch(`/opportunities/saved/${user.id}`);
                renderSavedOpportunities(savedOpps);
            } catch (error) {
                console.error('Final failure to load saved opportunities:', error);
                renderSavedOpportunities([]);
            }
        }

        function renderSavedOpportunities(savedOpps) {
            const listEl = document.getElementById('savedOpportunitiesList');

            if (!savedOpps || savedOpps.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        <p>You have not saved any opportunities yet.</p>
                                    <a href="search-opportunities.html" class="btn btn-primary">Search for Opportunities</a>
                    </div>
                `;
                return;
            }

            let html = '';
            savedOpps.forEach(opp => {
                html += `
                    <div class="recommendation-item" id="saved-item-${opp.id}">
                        <div class="rec-info">
                            <h4>${opp.title || 'Untitled Opportunity'}</h4>
                            <div class="rec-meta">ID: ${opp.id} &bull; Category: ${opp.category || 'Construction'} &bull; District: ${opp.district || '4'}</div>
                        </div>
                        <div class="rec-value" style="display: flex; gap: var(--space-sm); align-items: center;">
                            <button class="btn btn-small btn-primary" onclick="window.location.href='opportunity-details.html?id=${opp.id}'">View Details</button>
                            <button class="btn btn-small btn-outline" onclick="unsaveOpportunity('${opp.id}')" title="Remove from saved">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m18 6-12 12"/>
                                    <path d="m6 6 12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            });

            listEl.innerHTML = html;
        }


        // Unsave opportunity function
        async function unsaveOpportunity(opportunityId) {
            const user = JSON.parse(localStorage.getItem('caltrans_user'));
            if (!user) return;

            if (!confirm('Are you sure you want to remove this opportunity from your saved list?')) {
                return;
            }

            try {
                // Call API to unsave opportunity using DataService
                await DataService.fetch(`/opportunities/unsave`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: user.id,
                        opportunity_id: opportunityId
                    })
                });

                // Remove the item from DOM with animation
                const itemElement = document.getElementById(`saved-item-${opportunityId}`);
                if (itemElement) {
                    itemElement.style.opacity = '0';
                    itemElement.style.transform = 'translateX(-20px)';
                    itemElement.style.transition = 'all 0.3s ease';

                    setTimeout(() => {
                        itemElement.remove();

                        // Check if there are any remaining items
                        const remainingItems = document.querySelectorAll('.recommendation-item');
                        if (remainingItems.length === 0) {
                            document.getElementById('savedOpportunitiesList').innerHTML = `
                                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                    <p>You have no saved opportunities.</p>
                                                <a href="search-opportunities.html" class="btn btn-primary">Search for Opportunities</a>
                                </div>
                            `;
                        }
                    }, 300);
                }

            } catch (error) {
                console.error('Error unsaving opportunity:', error);
                alert('Error removing opportunity from saved list. Please try again.');
            }
        }
    </script>
</body>

</html>
