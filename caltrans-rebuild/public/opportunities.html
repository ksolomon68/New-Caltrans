<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Browse current contracting opportunities across all Caltrans districts. Filter by region, work category, and due date.">
  <title>Opportunities - CaltransBizConnect</title>
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="css/design-system.css">
  <link rel="stylesheet" href="css/main.css">
</head>

<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <header class="site-header" role="banner">
    <div class="container">
      <a href="index.html" class="site-logo">
        <img src="images/caltrans-logo.png" alt="Caltrans">
      </a>
      <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false"><span></span></button>
      <nav class="main-nav" role="navigation" id="dynamicNav">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="for-vendors.html">For Vendors</a></li>
          <li><a href="for-agencies.html">For Agencies</a></li>
          <li><a href="opportunities.html" class="active">Opportunities</a></li>
          <li><a href="how-it-works.html">How It Works</a></li>
          <li><a href="resources.html">Resources</a></li>
          <li><a href="faq.html">FAQ</a></li>
          <!-- Dynamic login/logout button will be inserted here -->
        </ul>
      </nav>
    </div>
  </header>

  <main id="main-content">
    <section class="container" style="padding: var(--space-xl) var(--container-padding);">
      <h1 class="mb-md">Current Opportunities</h1>
      <p class="mb-xl text-muted">Browse and filter contracting opportunities across all Caltrans districts. Log
        in to save opportunities and submit proposals.</p>

      <!-- Filter Bar -->
      <div class="filter-bar" role="search" aria-label="Filter opportunities">
        <div class="filter-grid">
          <div class="form-group mb-0">
            <label for="districtFilter">District/Region</label>
            <select id="districtFilter" name="district">
              <option value="">All Districts</option>
            </select>
          </div>

          <div class="form-group mb-0">
            <label for="categoryFilter">Work Category</label>
            <select id="categoryFilter" name="category">
              <option value="">All Categories</option>
            </select>
          </div>

          <div class="form-group mb-0">
            <label for="dueDateFilter">Due Date</label>
            <select id="dueDateFilter" name="dueDate">
              <option value="">Any Time</option>
              <option value="7">Next 7 Days</option>
              <option value="14">Next 14 Days</option>
              <option value="30">Next 30 Days</option>
            </select>
          </div>

          <div class="form-group mb-0">
            <label for="keywordFilter">Keywords</label>
            <input type="text" id="keywordFilter" name="keywords" placeholder="Search opportunities...">
          </div>
        </div>

        <div class="filter-actions">
          <button type="button" id="clearFilters" class="btn btn-outline btn-small">Clear Filters</button>
          <button type="button" id="applyFilters" class="btn btn-primary btn-small">Apply Filters</button>
        </div>
      </div>

      <!-- Results Count -->
      <div style="margin-bottom: var(--space-lg);">
        <p id="resultsCount" class="text-muted"><strong>Loading opportunities...</strong></p>
      </div>

      <!-- Opportunity List -->
      <div id="opportunityList" class="opportunity-list">
        <!-- Opportunities will be loaded here by JavaScript -->
      </div>

      <!-- No Results Message -->
      <div id="noResults" class="alert alert-info" style="display: none;">
        <strong>No opportunities found.</strong> Try adjusting your filters or check back later for new
        postings.
      </div>
    </section>
  </main>

  <footer class="site-footer" role="contentinfo">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>For Vendors</h3>
          <ul>
            <li><a href="for-vendors.html">Getting Started</a></li>
            <li><a href="register-vendor.html">Create Account</a></li>
            <li><a href="eligibility.html">Eligibility</a></li>
            <li><a href="resources.html">Resources</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h3>For Agencies</h3>
          <ul>
            <li><a href="for-agencies.html">Getting Started</a></li>
            <li><a href="register-agency.html">Create Account</a></li>
            <li><a href="opportunities.html">Opportunities</a></li>
            <li><a href="post-opportunity.html">Post Opportunity</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h3>Information</h3>
          <ul>
            <li><a href="how-it-works.html">How It Works</a></li>
            <li><a href="support-services.html">Support Services</a></li>

            <li><a href="faq.html">FAQ</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h3>Contact</h3>
          <ul>
            <li><a href="contact.html">Contact Us</a></li>
            <li><a href="report-issue.html">Report Site Issue</a></li>
            <li><a href="mailto:SBEss@dot.ca.gov">SBEss@dot.ca.gov</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h3>Forms & Services</h3>
          <ul>
            <li><a href="https://app.smartsheet.com/b/form/b0a6941664cd453da6912c4c96d83530" target="_blank"
                rel="noopener noreferrer">Service Request Form &nearrow;</a></li>
            <li><a href="https://app.smartsheet.com/b/form/5a91fd621bf6473cbe2e8dd2a5b1ecdd" target="_blank"
                rel="noopener noreferrer">Text Notifications &nearrow;</a></li>
            <li><a href="https://app.smartsheet.com/b/form/d10fcca77e37449abbf81c035b7945f6" target="_blank"
                rel="noopener noreferrer">BDP Interest Form &nearrow;</a></li>
            <li><a href="https://app.smartsheet.com/b/form/2070c1554666487584e007173d2208ed" target="_blank"
                rel="noopener noreferrer">Workforce Development &nearrow;</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h3>Caltrans Resources</h3>
          <ul>
            <li><a href="https://dot.ca.gov" target="_blank" rel="noopener noreferrer">Caltrans Home &nearrow;</a></li>
            <li><a href="https://dot.ca.gov/programs/civil-rights" target="_blank" rel="noopener noreferrer">Civil
                Rights &nearrow;</a></li>
            <li><a href="https://dot.ca.gov/programs/civil-rights/small-business-and-workforce-development"
                target="_blank" rel="noopener noreferrer">SB & Workforce Dev &nearrow;</a></li>
            <li><a href="https://ccop.dot.ca.gov/" target="_blank" rel="noopener noreferrer">Contracting Portal
                &nearrow;</a>
            </li>
            <li><a href="https://dot.ca.gov/programs/construction/construction-mentor-protege-program" target="_blank"
                rel="noopener noreferrer">Mentor Protege &nearrow;</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h3>External Programs</h3>
          <ul>
            <li><a href="https://calosba.ca.gov/" target="_blank" rel="noopener noreferrer">CA Small Business
                &nearrow;</a>
            </li>
            <li><a href="https://www.californiaucp.com" target="_blank" rel="noopener noreferrer">California UCP
                &nearrow;</a>
            </li>
            <li><a href="https://www.ecfr.gov/current/title-49/subtitle-A/part-26" target="_blank"
                rel="noopener noreferrer">Federal SBE Regs &nearrow;</a></li>
          </ul>
        </div>
      </div>

      <div class="footer-bottom">
        <p>&copy; 2026 California Department of Transportation. All rights reserved.</p>
        <p>CaltransBizConnect - Small Business Enterprise Supportive Services Business Development Program</p>
      </div>
    </div>
  </footer>

  <script src="js/config.js"></script>
  <script src="js/main.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils/data-resilience.js"></script>
  <script src="js/components/filter-bar.js"></script>
  <script>
    // Update navigation based on login status
    function updateNavigation() {
      const user = JSON.parse(localStorage.getItem('caltrans_user') || 'null');
      const nav = document.querySelector('#dynamicNav ul');

      // Remove existing login/logout buttons
      const existingButtons = nav.querySelectorAll('li:last-child');
      existingButtons.forEach(li => li.remove());

      if (user) {
        // User is logged in - add dashboard link
        const dashboardLi = document.createElement('li');
        let dashboardUrl = user.type === 'vendor' ? 'dashboard-vendor.html' :
          user.type === 'agency' ? 'dashboard-agency.html' :
            'dashboard-admin.html';
        dashboardLi.innerHTML = `<a href="${dashboardUrl}">Dashboard</a>`;
        nav.appendChild(dashboardLi);

        // Add logout button
        const logoutLi = document.createElement('li');
        logoutLi.innerHTML = '<a href="#" id="logoutBtn" class="btn btn-secondary btn-small">Log Out</a>';
        nav.appendChild(logoutLi);

        // Add logout handler
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
          e.preventDefault();
          logout();
        });
      } else {
        // User is not logged in - show login button
        const loginLi = document.createElement('li');
        loginLi.innerHTML = '<a href="login.html" class="btn btn-secondary btn-small">Log In</a>';
        nav.appendChild(loginLi);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Update navigation first
      updateNavigation();
    });

    // Global functions for inline handlers
    window.saveOpportunity = async function (id) {
      const user = getCurrentUser();
      if (!user) {
        // Redirection logic
        const currentUrl = encodeURIComponent(window.location.href);
        window.location.href = `login.html?redirect=${currentUrl}`;
        return;
      }

      let savedOpps = [];
      if (user.saved_opportunities) {
        try {
          savedOpps = JSON.parse(user.saved_opportunities);
        } catch (e) { savedOpps = user.saved_opportunities || []; }
      } else if (user.savedOpportunities) {
        savedOpps = user.savedOpportunities;
      }

      if (!Array.isArray(savedOpps)) savedOpps = [];

      if (!savedOpps.includes(id)) {
        savedOpps.push(id);
      } else {
        alert('Already saved!');
        return;
      }

      try {
        const API_BASE = window.APP_CONFIG ? window.APP_CONFIG.API_URL : '/api';
        // Update user object
        user.saved_opportunities = JSON.stringify(savedOpps); // keep consistant
        user.savedOpportunities = savedOpps;

        const response = await fetch(`${API_BASE}/auth/${user.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ savedOpportunities: savedOpps })
        });

        if (response.ok) {
          const updatedUser = await response.json();
          const SessionUser = { ...user, ...updatedUser };
          localStorage.setItem('caltrans_user', JSON.stringify(SessionUser));

          const btn = document.getElementById('saveOppBtn');
          if (btn) {
            btn.textContent = 'Saved';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            btn.disabled = true;
          }
          alert('Opportunity saved!');
        } else {
          throw new Error('Update failed');
        }
      } catch (e) {
        console.error('Save error:', e);
        alert('Failed to save opportunity.');
      }
    };

    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const detailId = urlParams.get('id');

      if (detailId) {
        await loadDetail(detailId);
      }

      const backBtn = document.getElementById('backBtn');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          document.getElementById('opportunityDetail').style.display = 'none';
          document.getElementById('opportunityList').style.display = 'grid';
          document.querySelector('.filter-bar').style.display = 'block';
          document.getElementById('resultsCount').style.display = 'block';
          document.getElementById('noResults').style.display = 'none';

          const url = new URL(window.location);
          url.searchParams.delete('id');
          window.history.pushState({}, '', url);

          // Re-run filter logic if needed, or reload? filter-bar.js should handle it.
          // Ideally we just show what was there.
        });
      }
    });

    async function loadDetail(id) {
      const contentDiv = document.getElementById('detailContent');
      if (!contentDiv) return;

      contentDiv.innerHTML = '<p>Loading details...</p>';

      document.getElementById('opportunityList').style.display = 'none';
      document.querySelector('.filter-bar').style.display = 'none';
      document.getElementById('resultsCount').style.display = 'none';
      document.getElementById('noResults').style.display = 'none';
      document.getElementById('opportunityDetail').style.display = 'block';

      try {
        const API_BASE = window.APP_CONFIG ? window.APP_CONFIG.API_URL : '/api';
        const response = await fetch(`${API_BASE}/opportunities`);
        const opportunities = await response.json();
        const opp = opportunities.find(o => o.id === id);

        if (!opp) {
          contentDiv.innerHTML = '<div class="alert alert-danger">Opportunity not found.</div>';
          return;
        }

        const user = getCurrentUser();
        const isVendor = user && user.type === 'vendor';

        let actionBtn = '';
        if (isVendor) {
          let savedOpps = [];
          if (user && user.saved_opportunities) {
            try { savedOpps = JSON.parse(user.saved_opportunities); } catch (e) { savedOpps = user.saved_opportunities; }
          } else if (user && user.savedOpportunities) {
            savedOpps = user.savedOpportunities;
          }
          if (!Array.isArray(savedOpps)) savedOpps = [];

          const isSaved = savedOpps.includes(id);

          actionBtn = `<button id="saveOppBtn" class="btn ${isSaved ? 'btn-success' : 'btn-primary'}" ${isSaved ? 'disabled' : ''} onclick="window.saveOpportunity('${id}')">${isSaved ? 'Saved' : 'Save Opportunity'}</button>`;
        } else if (user && user.type === 'agency' && (opp.posted_by == user.id || opp.postedBy == user.id)) {
          actionBtn = `<a href="post-opportunity.html?id=${id}" class="btn btn-outline">Edit Opportunity</a>`;
        }

        contentDiv.innerHTML = `
                  <div style="margin-bottom: var(--space-lg);">
                       <span class="badge badge-primary mb-sm">${opp.category_name || opp.categoryName || opp.category || 'General'}</span>
                       <h1 style="margin-top:0.5rem; margin-bottom:0.5rem;">${opp.title}</h1>
                       <div class="text-muted">ID: ${opp.id} &bull; Posted: ${new Date(opp.posted_date || Date.now()).toLocaleDateString()}</div>
                  </div>
                  
                  <div style="background:var(--color-bg-secondary); padding:var(--space-md); border-radius:var(--border-radius-md); margin-bottom:var(--space-xl); display:flex; gap:var(--space-xl); flex-wrap:wrap;">
                       <div>
                           <div style="font-weight:bold; color:var(--text-muted); font-size:0.875rem;">ESTIMATED VALUE</div>
                           <div style="font-size:1.25rem; font-weight:bold;">${opp.estimated_value || opp.estimatedValue || 'TBD'}</div>
                       </div>
                       <div>
                           <div style="font-weight:bold; color:var(--text-muted); font-size:0.875rem;">DUE DATE</div>
                           <div style="font-size:1.25rem; font-weight:bold;">${opp.due_date || opp.dueDate || 'Open'}</div>
                       </div>
                       <div>
                           <div style="font-weight:bold; color:var(--text-muted); font-size:0.875rem;">REGION</div>
                           <div style="font-size:1.25rem; font-weight:bold;">${opp.district_name || opp.districtName || ('District ' + opp.district)}</div>
                       </div>
                  </div>

                  <h3 class="mb-md">Description</h3>
                  <div style="line-height:1.6; margin-bottom:var(--space-2xl);">
                      ${(opp.scope_summary || opp.scopeSummary || 'No description provided.').replace(/\n/g, '<br>')}
                  </div>
                  
                   <div style="display: flex; gap: var(--space-md); border-top:1px solid var(--color-border-light); padding-top:var(--space-lg);">
                      ${actionBtn}
                      <a href="contact.html" class="btn btn-outline">Contact Officer</a>
                  </div>
              `;

      } catch (e) {
        console.error(e);
        contentDiv.innerHTML = 'Error loading details.';
      }
    }
  </script>
</body>

</html>