<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Opportunity - CaltransBizConnect</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/dashboard-new.css">
    <link rel="stylesheet" href="css/dashboard-common.css">
    <style>
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--space-xl);
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-xl);
            position: relative;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            right: -50%;
            height: 2px;
            background: var(--color-border-light);
            z-index: 1;
        }

        .step:last-child::before {
            display: none;
        }

        .step.active {
            color: var(--color-primary);
        }

        .step.active::before {
            background: var(--color-primary);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--color-bg-secondary);
            border: 2px solid var(--color-border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin: 0 auto var(--space-sm);
            position: relative;
            z-index: 2;
        }

        .step.active .step-number {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
        }

        @media (max-width: 768px) {
            .form-container {
                padding: var(--space-md);
            }

            .step-indicator {
                flex-direction: column;
                gap: var(--space-md);
            }

            .step::before {
                display: none;
            }
        }
    </style>
</head>

<body class="dashboard-v2">
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <aside class="sidebar" id="sidebar"></aside>

    <div class="dashboard-container">
        <header class="header-top" id="header-top"></header>

        <!-- Main Content -->
        <main id="main-content" class="main-content">

            <!-- Hero Section -->
            <section class="hero-section">
                <div class="hero-content">
                    <div class="hero-welcome">
                        <h1 class="page-title">Post New Opportunity</h1>
                        <p>Create and publish new contracting opportunities for qualified vendors.</p>
                    </div>
                </div>
            </section>

            <!-- Form Container -->
            <div class="form-container">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div>Basic Info</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div>Details</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div>Requirements</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-number">4</div>
                        <div>Review</div>
                    </div>
                </div>

                <!-- Form -->
                <form id="opportunityForm">
                    <!-- Step 1: Basic Information -->
                    <div class="form-step active" id="formStep1">
                        <div class="content-card">
                            <h3>Basic Information</h3>
                            <div class="form-group">
                                <label for="title" class="required">Opportunity Title</label>
                                <input type="text" id="title" name="title" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="category" class="required">Category</label>
                                <select id="category" name="category" class="form-control" required>
                                    <option value="">Select a category</option>
                                    <option value="construction">Construction</option>
                                    <option value="engineering">Engineering</option>
                                    <option value="consulting">Consulting</option>
                                    <option value="supplies">Supplies & Materials</option>
                                    <option value="services">Professional Services</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="district" class="required">District</label>
                                    <select id="district" name="district" class="form-control" required>
                                        <option value="">Select district</option>
                                        <option value="1">District 1 (Eureka)</option>
                                        <option value="2">District 2 (Redding)</option>
                                        <option value="3">District 3 (Marysville)</option>
                                        <option value="4">District 4 (Bay Area)</option>
                                        <option value="5">District 5 (San Luis Obispo)</option>
                                        <option value="6">District 6 (Fresno)</option>
                                        <option value="7">District 7 (Los Angeles)</option>
                                        <option value="8">District 8 (San Bernardino)</option>
                                        <option value="9">District 9 (Bishop)</option>
                                        <option value="10">District 10 (Stockton)</option>
                                        <option value="11">District 11 (San Diego)</option>
                                        <option value="12">District 12 (Orange County)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="dueDate" class="required">Application Deadline</label>
                                    <input type="date" id="dueDate" name="dueDate" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-md); justify-content: flex-end;">
                            <button type="button" class="btn btn-primary" onclick="nextStep(2)">Next Step</button>
                        </div>
                    </div>

                    <!-- Step 2: Details -->
                    <div class="form-step" id="formStep2">
                        <div class="content-card">
                            <h3>Opportunity Details</h3>
                            <div class="form-group">
                                <label for="description" class="required">Description</label>
                                <textarea id="description" name="description" class="form-control" rows="6" required
                                    placeholder="Provide a detailed description of the opportunity..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="budget" class="required">Estimated Budget</label>
                                <input type="text" id="budget" name="budget" class="form-control" required
                                    placeholder="$100,000 - $500,000">
                            </div>
                            <div class="form-group">
                                <label for="duration" class="required">Project Duration</label>
                                <input type="text" id="duration" name="duration" class="form-control" required
                                    placeholder="e.g., 6 months, 1 year">
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-md); justify-content: space-between;">
                            <button type="button" class="btn btn-outline" onclick="nextStep(1)">Previous</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep(3)">Next Step</button>
                        </div>
                    </div>

                    <!-- Step 3: Requirements -->
                    <div class="form-step" id="formStep3">
                        <div class="content-card">
                            <h3>Requirements & Qualifications</h3>
                            <div class="form-group">
                                <label for="requirements" class="required">Requirements</label>
                                <textarea id="requirements" name="requirements" class="form-control" rows="6" required
                                    placeholder="List specific requirements for vendors..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="certifications">Required Certifications</label>
                                <textarea id="certifications" name="certifications" class="form-control" rows="4"
                                    placeholder="e.g., SBE, DBE, WBE..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="experience">Experience Required</label>
                                <textarea id="experience" name="experience" class="form-control" rows="4"
                                    placeholder="Minimum experience requirements..."></textarea>
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-md); justify-content: space-between;">
                            <button type="button" class="btn btn-outline" onclick="nextStep(2)">Previous</button>
                            <button type="button" class="btn btn-primary" onclick="nextStep(4)">Review & Post</button>
                        </div>
                    </div>

                    <!-- Step 4: Review -->
                    <div class="form-step" id="formStep4">
                        <div class="content-card">
                            <h1 class="page-title">Review & Submit</h1>
                            <div id="reviewContent">
                                <div style="text-align: center; padding: 2rem;">
                                    <p>Please complete all form fields to review your opportunity before posting.</p>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-md); justify-content: space-between;">
                            <button type="button" class="btn btn-outline" onclick="nextStep(3)">Previous</button>
                            <button type="submit" class="btn btn-primary">Post Opportunity</button>
                        </div>
                    </div>
                </form>
            </div>

        </main>
    </div>



    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils/data-resilience.js"></script>
    <script src="js/components/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                Navigation.init('agency');
                initializeForm();
            }, 50);
        });

        let currentStep = 1;

        function initializeForm() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dueDate').setAttribute('min', today);

            // Get opportunity ID from URL if editing
            const urlParams = new URLSearchParams(window.location.search);
            const opportunityId = urlParams.get('id');
            if (opportunityId) {
                loadOpportunity(opportunityId);
            }

            // Handle form submission
            document.getElementById('opportunityForm').addEventListener('submit', handleSubmit);
        }

        function nextStep(step) {
            // Hide current step
            document.getElementById(`formStep${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.remove('active');

            // Show new step
            currentStep = step;
            document.getElementById(`formStep${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}`).classList.add('active');

            // Update review if going to step 4
            if (step === 4) {
                updateReview();
            }

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function updateReview() {
            const formData = new FormData(document.getElementById('opportunityForm'));
            const data = Object.fromEntries(formData.entries());

            const reviewHTML = `
                <div class="review-section">
                    <h4>Basic Information</h4>
                    <p><strong>Title:</strong> ${data.title}</p>
                    <p><strong>Category:</strong> ${data.category}</p>
                    <p><strong>District:</strong> District ${data.district}</p>
                    <p><strong>Deadline:</strong> ${new Date(data.dueDate).toLocaleDateString()}</p>
                </div>
                <div class="review-section">
                    <h4>Details</h4>
                    <p><strong>Description:</strong> ${data.description}</p>
                    <p><strong>Budget:</strong> ${data.budget}</p>
                    <p><strong>Duration:</strong> ${data.duration}</p>
                </div>
                <div class="review-section">
                    <h4>Requirements</h4>
                    <p><strong>Requirements:</strong> ${data.requirements}</p>
                    <p><strong>Certifications:</strong> ${data.certifications || 'None specified'}</p>
                    <p><strong>Experience:</strong> ${data.experience || 'None specified'}</p>
                </div>
            `;

            document.getElementById('reviewContent').innerHTML = reviewHTML;
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            const user = JSON.parse(localStorage.getItem('caltrans_user'));
            if (!user) {
                alert('Please log in to post an opportunity.');
                return;
            }

            try {
                // Generate ID if new
                const urlParams = new URLSearchParams(window.location.search);
                const isEdit = !!urlParams.get('id');
                const id = isEdit ? urlParams.get('id') : 'OPP-' + Date.now();

                // Determine method and endpoint
                const method = isEdit ? 'PUT' : 'POST';
                const endpoint = isEdit ? `/opportunities/${id}` : '/opportunities';

                // Get display names
                const districtSelect = document.getElementById('district');
                const districtName = districtSelect.options[districtSelect.selectedIndex].text;

                const categorySelect = document.getElementById('category');
                const categoryName = categorySelect.options[categorySelect.selectedIndex].text;

                // Add required fields and map names for backend
                const payload = {
                    id: id,
                    title: data.title,
                    category: data.category,
                    categoryName: categoryName,
                    district: data.district,
                    districtName: districtName,
                    dueDate: data.dueDate,
                    scopeSummary: data.description,
                    estimatedValue: data.budget,
                    duration: data.duration,
                    requirements: data.requirements,
                    certifications: data.certifications,
                    experience: data.experience,
                    submissionMethod: 'Online',
                    postedBy: user.id
                };

                const result = await DataService.fetch(endpoint, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (result.error) throw new Error(result.error);

                alert(isEdit ? 'âœ… Opportunity updated successfully!' : 'ðŸš€ Opportunity posted successfully!');
                window.location.href = 'manage-opportunities.html';

            } catch (error) {
                console.error('Error posting opportunity:', error);
                alert('âŒ Failed to post opportunity. This might be a connection issue or missing field. Please check the form and try again.');
            }
        }

        async function loadOpportunity(id) {
            console.log('Loading opportunity for editing:', id);
            try {
                const opp = await DataService.fetch(`/opportunities/${id}`);
                if (!opp || opp.error) throw new Error('Opportunity not found');

                // Helper to safely set value
                const setVal = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.value = val || '';
                };

                // Explicit mapping of DB fields to form IDs
                setVal('title', opp.title);
                setVal('category', opp.category);
                setVal('district', opp.district);
                setVal('description', opp.scope_summary); // map scope_summary -> description
                setVal('budget', opp.estimated_value);     // map estimated_value -> budget
                setVal('duration', opp.duration);
                setVal('requirements', opp.requirements);
                setVal('certifications', opp.certifications);
                setVal('experience', opp.experience);

                // Date handling
                if (opp.due_date) {
                    const d = new Date(opp.due_date);
                    if (!isNaN(d.getTime())) {
                        document.getElementById('dueDate').value = d.toISOString().split('T')[0];
                    }
                }

                // Update page title
                document.querySelector('h1').textContent = 'Edit Opportunity';
                document.querySelector('.hero-welcome p').textContent = 'Update details for ' + opp.title;
                document.querySelector('button[type="submit"]').textContent = 'Update Opportunity';

            } catch (error) {
                console.error('Error loading opportunity:', error);
                alert('Could not load opportunity. It may have been deleted.');
                window.location.href = 'manage-opportunities.html';
            }
        }
    </script>

</body>

</html>
