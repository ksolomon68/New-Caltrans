<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - CaltransBizConnect</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/dashboard-new.css">
    <link rel="stylesheet" href="css/dashboard-common.css">
    <style>
        /* Shared Dashboard Styles */
        body.dashboard-v2 {
            background: linear-gradient(135deg, var(--color-bg-secondary) 0%, var(--color-bg-tertiary) 100%);
            min-height: 100vh;
        }

        .hero-section {
            background: linear-gradient(135deg, var(--brand-blue) 0%, var(--color-primary-light) 100%);
            color: white;
            padding: var(--space-2xl) var(--space-xl);
            border-radius: var(--border-radius-lg);
            margin-bottom: var(--space-xl);
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></linearGradient></defs><rect width="100" height="100" fill="url(%23grad)"/></svg>');
            background-size: cover;
            opacity: 0.3;
        }

        .hero-welcome h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: var(--space-sm);
        }

        /* Enhanced Card for Table */
        .content-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--color-border-light);
            padding: var(--space-xl);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Table Styles */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-lg);
        }

        .user-table th {
            text-align: left;
            padding: var(--space-md);
            border-bottom: 2px solid var(--color-border-light);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-table td {
            padding: var(--space-md);
            border-bottom: 1px solid var(--color-border-light);
            vertical-align: middle;
        }

        .user-table tr:hover {
            background-color: var(--color-bg-secondary);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-container {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-xl);
            transform: translateY(20px);
            transition: transform 0.2s ease;
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--color-border-light);
            padding-bottom: 1rem;
        }
    </style>
</head>

<body class="dashboard-v2">
    <aside class="sidebar" id="sidebar"></aside>

    <div class="dashboard-container">
        <header class="header-top" id="header-top"></header>

        <!-- Main Content -->
        <main id="main-content" class="main-content">

            <!-- Hero Section -->
            <section class="hero-section">
                <div class="hero-content">
                    <div class="hero-welcome">
                        <h1 class="page-title">User Management</h1>
                        <p style="opacity: 0.9;">View and verify registered vendors and agencies.</p>
                    </div>
                </div>
            </section>

            <!-- User Table Section -->
            <section class="content-card">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                    <h3 style="font-size: 1.5rem; color: var(--color-primary); font-weight: 700;">All Users</h3>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div style="position: relative;">
                            <input type="text" placeholder="Search users..." onkeyup="filterUsers(this.value)"
                                style="padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius-md); border: 1px solid var(--color-border-light); width: 250px;">
                        </div>
                        <button class="btn btn-primary" onclick="openAddModal()">+ Add New User</button>
                    </div>
                </div>

                <table class="user-table">
                    <thead>
                        <tr>
                            <th>User / Business</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                                Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <!-- Manage User Modal -->
    <div id="manageUserModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" style="margin: 0; color: var(--color-primary);">Manage User</h3>
                <button class="close-modal" onclick="closeModal()"
                    style="border: none; background: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">User / Organization
                        Name</label>
                    <input type="text" id="modalUserName" class="form-input" placeholder="Enter name"
                        style="width: 100%;">
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Email Address</label>
                    <input type="email" id="modalUserEmail" class="form-input" placeholder="example@dot.ca.gov"
                        style="width: 100%;">
                </div>
                <div id="passwordGroup" class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Password</label>
                    <input type="password" id="modalUserPassword" class="form-input"
                        placeholder="Enter password (leave blank to keep current if editing)" style="width: 100%;">
                    <small id="passwordHelp" class="text-muted" style="display: none;">Only required for new
                        accounts</small>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Account Type</label>
                    <select id="modalUserType" class="form-input" style="width: 100%;">
                        <option value="vendor">Vendor</option>
                        <option value="agency">Agency</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Account Status</label>
                    <select id="modalUserStatus" class="form-input" style="width: 100%;">
                        <option value="active">Active</option>
                        <option value="pending">Pending Verification</option>
                        <option value="suspended">Suspended</option>
                        <option value="verified">Verified Vendor</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: space-between;">
                    <button class="btn btn-outline-error" id="btnDeleteUser" onclick="deleteUser()"
                        style="display: none;">Delete User</button>
                    <div style="display: flex; gap: 1rem; margin-left: auto;">
                        <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-primary" id="btnSaveUser" onclick="saveUser()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils/data-resilience.js"></script>
    <script src="js/components/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Strict Admin Check
            const user = Auth.getUser();
            if (!user || user.type !== 'admin') {
                window.location.href = 'index.html';
                return;
            }

            setTimeout(() => {
                Navigation.init('admin');
                loadUsers();
            }, 50);
        });

        let currentUsers = [];
        let selectedUserId = null;

        async function loadUsers() {
            try {
                const user = Auth.getUser();
                const headers = { 'X-Admin-Email': user ? user.email : 'admin@test.com' };

                let users = await DataService.fetch('/admin/users', { headers });

                currentUsers = users || [];
                renderUsers(currentUsers);
            } catch (error) {
                console.error('Failure to load users:', error);
                // Fallback for visual verification if backend is empty/broken during dev
                if (!currentUsers.length) {
                    currentUsers = [
                        { id: 1, business_name: 'Acme Construction', email: 'contact@acme.com', type: 'vendor', status: 'verified', created_at: '2025-01-15' },
                        { id: 2, organization_name: 'City of Sacramento', email: 'planning@city.gov', type: 'agency', status: 'active', created_at: '2025-02-01' }
                    ];
                }
                renderUsers(currentUsers);
            }
        }

        function renderUsers(users) {
            const userTableBody = document.getElementById('userTableBody');
            userTableBody.innerHTML = '';

            if (users.length === 0) {
                userTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No users found</td></tr>';
                return;
            }

            users.forEach(u => {
                const row = document.createElement('tr');
                const displayName = u.business_name || u.organization_name || u.email;
                const status = u.status || 'active';

                const typeBadge = u.type === 'vendor'
                    ? '<span class="badge badge-secondary">Vendor</span>'
                    : (u.type === 'agency' ? '<span class="badge badge-primary">Agency</span>'
                        : '<span class="badge badge-outline">Admin</span>');

                let statusColor = 'var(--color-success)';
                if (status === 'pending') statusColor = 'var(--color-warning)';
                if (status === 'suspended') statusColor = 'var(--color-error)';

                const statusLabel = status.charAt(0).toUpperCase() + status.slice(1);

                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600; color: var(--color-primary);">${displayName}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${u.email}</div>
                    </td>
                    <td>${typeBadge}</td>
                    <td><span style="color: ${statusColor};">‚óè ${statusLabel}</span></td>
                    <td>${new Date(u.created_at || Date.now()).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-small btn-outline" onclick="openManageModal(${u.id})">Manage</button>
                    </td>
                `;
                userTableBody.appendChild(row);
            });
        }

        function filterUsers(term) {
            term = term.toLowerCase();
            const filtered = currentUsers.filter(u =>
                (u.business_name || (u.email.split('@')[0])).toLowerCase().includes(term) ||
                (u.organization_name || '').toLowerCase().includes(term) ||
                (u.email || '').toLowerCase().includes(term)
            );
            renderUsers(filtered);
        }

        window.openAddModal = function () {
            selectedUserId = null;
            document.querySelector('.modal-title').textContent = 'Add New User';
            document.getElementById('modalUserName').value = '';
            document.getElementById('modalUserEmail').value = '';
            document.getElementById('modalUserPassword').value = '';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('modalUserType').value = 'vendor';
            document.getElementById('modalUserStatus').value = 'active';
            document.getElementById('btnDeleteUser').style.display = 'none';
            document.getElementById('btnSaveUser').textContent = 'Create User';
            document.getElementById('manageUserModal').classList.add('active');
        };

        window.openManageModal = function (id) {
            selectedUserId = id;
            const u = currentUsers.find(user => user.id === id);
            if (!u) return;

            document.querySelector('.modal-title').textContent = 'Edit User';
            document.getElementById('modalUserName').value = u.business_name || u.organization_name || '';
            document.getElementById('modalUserEmail').value = u.email;
            document.getElementById('modalUserPassword').value = '';
            document.getElementById('passwordGroup').style.display = 'block'; // Keep it for password reset
            document.getElementById('modalUserType').value = u.type || 'vendor';
            document.getElementById('modalUserStatus').value = u.status || 'active';
            document.getElementById('btnDeleteUser').style.display = 'block';
            document.getElementById('btnSaveUser').textContent = 'Save Changes';

            document.getElementById('manageUserModal').classList.add('active');
        };

        window.closeModal = function () {
            document.getElementById('manageUserModal').classList.remove('active');
            selectedUserId = null;
        };

        window.saveUser = async function () {
            const user = Auth.getUser();
            const headers = {
                'X-Admin-Email': user ? user.email : 'admin@test.com',
                'Content-Type': 'application/json'
            };

            const userData = {
                email: document.getElementById('modalUserEmail').value,
                type: document.getElementById('modalUserType').value,
                status: document.getElementById('modalUserStatus').value,
                business_name: document.getElementById('modalUserType').value === 'vendor' ? document.getElementById('modalUserName').value : null,
                organization_name: document.getElementById('modalUserType').value === 'agency' ? document.getElementById('modalUserName').value : null
            };

            const password = document.getElementById('modalUserPassword').value;
            if (password) userData.password = password;

            if (!selectedUserId && !password) {
                alert('Password is required for new users');
                return;
            }

            try {
                let result;
                if (selectedUserId) {
                    // Update
                    result = await DataService.fetch(`/admin/users/${selectedUserId}`, {
                        method: 'PUT',
                        headers,
                        body: JSON.stringify(userData)
                    });
                } else {
                    // Create
                    result = await DataService.fetch('/admin/users', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(userData)
                    });
                }

                if (result.error) throw new Error(result.error);

                alert(selectedUserId ? 'User updated successfully' : 'User created successfully');
                closeModal();
                loadUsers();
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Error saving user: ' + error.message);
            }
        };

        window.deleteUser = async function () {
            if (!selectedUserId) return;
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            const user = Auth.getUser();
            const headers = { 'X-Admin-Email': user ? user.email : 'admin@test.com' };

            try {
                const result = await DataService.fetch(`/admin/users/${selectedUserId}`, {
                    method: 'DELETE',
                    headers
                });

                if (result.error) throw new Error(result.error);

                alert('User deleted successfully');
                closeModal();
                loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user: ' + error.message);
            }
        };
    </script>
</body>

</html>